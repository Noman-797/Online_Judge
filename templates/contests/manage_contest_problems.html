{% extends 'base.html' %}

{% block title %}Manage Contest Problems - {{ contest.title }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-6">
    <div class="bg-white rounded-lg shadow-sm border mb-6">
        <div class="p-4 border-b bg-gradient-to-r from-purple-50 to-indigo-50">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                        <i class="fas fa-tasks text-purple-600"></i>
                        Manage Problems
                    </h1>
                    <p class="text-sm text-gray-600 mt-1">{{ contest.title }}</p>
                </div>
                <a href="{% url 'contests:admin_contests' %}" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm font-medium shadow-sm">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Contests
                </a>
            </div>
        </div>
    </div>

    <!-- Add Problem Form -->
    {% if contest.status != 'ended' %}
    <div class="bg-white rounded-lg shadow-sm border mb-6">
        <div class="p-4 border-b">
            <h2 class="font-semibold text-gray-900 flex items-center gap-2">
                <i class="fas fa-plus text-green-600"></i>
                Add Problem
            </h2>
        </div>
        <div class="p-4">
            <form method="post">
                {% csrf_token %}
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Problem</label>
                        {{ form.problem }}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Order</label>
                        {{ form.order }}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Points</label>
                        {{ form.points }}
                    </div>
                    <div class="flex items-end">
                        <button type="submit" name="add_existing" class="bg-green-600 text-white px-6 py-2.5 rounded-lg hover:bg-green-700 font-medium shadow-sm transition-colors">
                            <i class="fas fa-plus mr-2"></i>Add Problem
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    {% else %}
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6 text-center">
        <i class="fas fa-lock text-yellow-600 text-xl mb-2"></i>
        <p class="text-yellow-700 font-medium">Contest has ended. Cannot add new problems.</p>
    </div>
    {% endif %}

    <!-- Current Problems -->
    <div class="bg-white rounded-lg shadow-sm border">
        <div class="p-4 border-b bg-gradient-to-r from-blue-50 to-indigo-50">
            <div class="flex items-center justify-between">
                <h2 class="font-semibold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-list text-blue-600"></i>
                    Contest Problems
                </h2>
                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                    {{ contest_problems.count }} problems
                </span>
            </div>
        </div>
        <div class="p-4">
            {% if contest_problems %}
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Order</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Problem</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Difficulty</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Points</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for cp in contest_problems %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3">
                                <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded font-mono text-sm">{{ cp.order }}</span>
                            </td>
                            <td class="px-4 py-3">
                                <div class="font-medium text-gray-900">{{ cp.problem.title }}</div>
                                <div class="text-sm text-gray-500">{{ cp.problem.category.name }}</div>
                            </td>
                            <td class="px-4 py-3">
                                {% if cp.problem.difficulty == 'Easy' %}
                                    <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm font-medium">Easy</span>
                                {% elif cp.problem.difficulty == 'Medium' %}
                                    <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-sm font-medium">Medium</span>
                                {% else %}
                                    <span class="bg-red-100 text-red-800 px-2 py-1 rounded text-sm font-medium">Hard</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3">
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded font-semibold text-sm">{{ cp.points }}</span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <div class="flex items-center justify-center gap-1">
                                    <a href="{% url 'contests:edit_contest_problem' contest.slug cp.id %}" 
                                       class="bg-blue-500 text-white hover:bg-blue-600 px-2 py-1 rounded-md text-sm font-medium transition-colors"
                                       title="Edit">
                                        <i class="fas fa-edit text-xs"></i>
                                    </a>
                                    <button onclick="showRemoveModal('{{ cp.id }}', '{{ cp.problem.title|escapejs }}')"
                                            class="bg-red-500 text-white hover:bg-red-600 px-2 py-1 rounded-md text-sm font-medium transition-colors"
                                            title="Remove">
                                        <i class="fas fa-trash text-xs"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-8">
                <i class="fas fa-tasks text-3xl text-gray-400 mb-3"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No problems added yet</h3>
                <p class="text-gray-500">Add problems to make this contest available for participants</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Remove Confirmation Modal -->
<div id="removeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md mx-4">
        <div class="flex items-center gap-3 mb-4">
            <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
            <h3 class="text-lg font-semibold text-gray-900">Remove Problem</h3>
        </div>
        <p class="text-gray-600 mb-6">Are you sure you want to remove <strong id="problemTitle"></strong> from this contest?</p>
        <div class="flex gap-3 justify-end">
            <button onclick="hideRemoveModal()" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 font-medium">
                Cancel
            </button>
            <a id="confirmRemove" href="#" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 font-medium">
                Remove
            </a>
        </div>
    </div>
</div>

<script>
function showRemoveModal(problemId, problemTitle) {
    document.getElementById('problemTitle').textContent = problemTitle;
    document.getElementById('confirmRemove').href = `/contests/admin/{{ contest.slug }}/problems/${problemId}/remove/`;
    document.getElementById('removeModal').classList.remove('hidden');
    document.getElementById('removeModal').classList.add('flex');
}

function hideRemoveModal() {
    document.getElementById('removeModal').classList.add('hidden');
    document.getElementById('removeModal').classList.remove('flex');
}

// Close modal on outside click
document.getElementById('removeModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideRemoveModal();
    }
});
</script>
{% endblock %}