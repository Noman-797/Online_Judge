{% extends 'base.html' %}

{% block title %}{{ discussion.title }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="mb-6">
        <div class="flex items-center gap-4 mb-4">
            <a href="{% url 'communications:problem_discussions' discussion.problem.slug %}" class="btn btn-outline btn-sm">
                <i class="fas fa-arrow-left mr-1"></i>Back to Discussions
            </a>
            {% if user.is_staff and not discussion.is_resolved %}
                <button class="btn btn-success btn-sm" onclick="markResolved({{ discussion.id }})">
                    <i class="fas fa-check mr-1"></i>Mark Resolved
                </button>
            {% endif %}
        </div>
        <h1 class="text-2xl font-bold text-gray-900">{{ discussion.title }}</h1>
        <p class="text-gray-600">Problem: <a href="{% url 'problems:problem_solve' discussion.problem.slug %}" class="link">{{ discussion.problem.title }}</a></p>
    </div>

    <!-- Original Discussion -->
    <div class="card bg-base-100 shadow-xl mb-6">
        <div class="card-body">
            <div class="flex items-start gap-4">
                <div class="avatar placeholder">
                    <div class="bg-neutral text-neutral-content rounded-full w-12">
                        <span class="text-xl">{{ discussion.user.username|first|upper }}</span>
                    </div>
                </div>
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="font-semibold">{{ discussion.user.username }}</span>
                        {% if discussion.user.is_staff %}
                            <span class="badge badge-primary badge-sm">Staff</span>
                        {% endif %}
                        <span class="text-sm text-gray-500">{{ discussion.created_at|timesince }} ago</span>
                    </div>
                    <div class="prose max-w-none">
                        {{ discussion.message|linebreaks }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Replies -->
    <div id="replies-container">
        {% for reply in replies %}
            {% include 'communications/reply_item.html' %}
        {% endfor %}
    </div>

    <!-- Reply Form -->
    <div class="card bg-base-100 shadow-xl mt-6">
        <div class="card-body">
            <h3 class="card-title">Add Reply</h3>
            <form id="reply-form" method="post">
                {% csrf_token %}
                <div class="form-control mb-4">
                    {{ form.message }}
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-reply mr-1"></i>Reply
                </button>
            </form>
        </div>
    </div>
</div>

<script>
document.getElementById('reply-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('replies-container').insertAdjacentHTML('beforeend', data.reply_html);
            document.getElementById('reply-form').reset();
        }
    })
    .catch(error => console.error('Error:', error));
});

function markResolved(discussionId) {
    // Implementation for marking discussion as resolved
    fetch(`/communications/discussion/${discussionId}/resolve/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}
</script>
{% endblock %}